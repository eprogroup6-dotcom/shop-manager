<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shop Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .active-sale { border-color: #10b981; background-color: #ecfdf5; color: #059669; }
        .active-expense { border-color: #ef4444; background-color: #fef2f2; color: #dc2626; }
        #auth-overlay { backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 pb-10">

    <div id="auth-overlay" class="fixed inset-0 z-50 bg-indigo-900/90 flex flex-col items-center justify-center p-6 text-white transition-opacity duration-500">
        <h2 class="text-2xl font-bold mb-6">Enter Admin PIN</h2>
        <input type="password" id="pin-input" inputmode="numeric" placeholder="••••" class="bg-white/10 border-2 border-white/20 rounded-2xl p-4 text-center text-3xl tracking-widest w-48 mb-6 focus:outline-none focus:border-white">
        <button onclick="checkPin()" class="bg-white text-indigo-900 font-bold px-10 py-4 rounded-2xl active:scale-95 transition-transform">Unlock Ledger</button>
    </div>

    <div id="main-content" class="hidden p-4 space-y-4">
        
        <div class="bg-indigo-700 rounded-[2rem] p-6 text-white shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-xs font-black uppercase tracking-widest opacity-70">Daily Ledger</h1>
                <span id="current-time" class="text-[10px] bg-indigo-800 px-3 py-1 rounded-full font-mono text-green-300">00:00:00</span>
            </div>
            <p id="stat-profit" class="text-4xl font-black mb-6">Ksh 0</p>
            <div class="grid grid-cols-2 gap-4 pt-5 border-t border-indigo-500/50">
                <div class="bg-indigo-800/40 p-3 rounded-2xl">
                    <p class="text-[10px] opacity-70 font-bold uppercase">Sales (<span id="count-sale">0</span>)</p>
                    <p id="stat-sales" class="text-lg font-bold">Ksh 0</p>
                </div>
                <div class="bg-indigo-800/40 p-3 rounded-2xl">
                    <p class="text-[10px] opacity-70 font-bold uppercase">Exp (<span id="count-expense">0</span>)</p>
                    <p id="stat-expenses" class="text-lg font-bold">Ksh 0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
            <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-5">
                <button onclick="setType('sale')" id="btn-sale" class="active-sale flex-1 py-3 rounded-xl font-bold border-2">Sale</button>
                <button onclick="setType('expense')" id="btn-expense" class="flex-1 py-3 rounded-xl font-bold border-2 border-transparent text-slate-500">Expense</button>
            </div>
            <div class="space-y-4">
                <select id="item-desc" class="w-full p-4 bg-slate-50 border-none rounded-2xl text-slate-700 font-medium appearance-none">
                    <optgroup label="Products for Sale" id="opt-sales">
                        <option>Soda</option><option>Bread</option><option>Milk</option><option>Sugar</option><option>Snacks</option><option>Other Sale</option>
                    </optgroup>
                    <optgroup label="Expenses" id="opt-expenses" class="hidden">
                        <option>Transport</option><option>Electricity</option><option>Airtime</option><option>Packaging</option><option>Water</option><option>Other Expense</option>
                    </optgroup>
                </select>
                <input type="number" id="amount" inputmode="decimal" placeholder="Ksh Amount" class="w-full p-4 bg-slate-50 border-none rounded-2xl text-2xl font-black text-indigo-700">
                <button onclick="addRecord()" id="save-btn" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold active:scale-95 transition-all">Save Transaction</button>
            </div>
        </div>

        <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
            <canvas id="liveChart" height="180"></canvas>
        </div>

        <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
            <h3 class="text-xs font-black text-slate-400 uppercase mb-4">Today's History (Latest 5)</h3>
            <div id="history-list" class="space-y-3">
                </div>
        </div>
    </div>

    <script>
        const MY_PIN = "1234"; // CHANGE YOUR PASSWORD HERE
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbwIfWV_eBBR6LowyF17kiuBchg5oQFYxT_zOyxO6eOdbfj50rGJQhE8uyWYaDLXddfmlA/exec";
        
        let currentType = 'sale';
        let records = JSON.parse(localStorage.getItem('daily_records')) || [];

        function checkPin() {
            const input = document.getElementById('pin-input').value;
            if(input === MY_PIN) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } else {
                alert("Wrong PIN");
                document.getElementById('pin-input').value = '';
            }
        }

        // Timer & Midnight Reset
        setInterval(() => {
            const now = new Date();
            const today = now.toDateString();
            if (localStorage.getItem('last_reset_date') !== today) {
                records = [];
                localStorage.setItem('daily_records', JSON.stringify([]));
                localStorage.setItem('last_reset_date', today);
                updateDashboard();
            }
            document.getElementById('current-time').innerText = now.toLocaleTimeString();
        }, 1000);

        // Chart Setup
        const ctx = document.getElementById('liveChart').getContext('2d');
        const liveChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Sales', 'Expenses'],
                datasets: [{ data: [0, 0], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 10 }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
        });

        function setType(type) {
            currentType = type;
            const isSale = type === 'sale';
            document.getElementById('btn-sale').className = isSale ? 'active-sale flex-1 py-3 rounded-xl font-bold border-2' : 'flex-1 py-3 rounded-xl font-bold border-2 border-transparent text-slate-500';
            document.getElementById('btn-expense').className = !isSale ? 'active-expense flex-1 py-3 rounded-xl font-bold border-2' : 'flex-1 py-3 rounded-xl font-bold border-2 border-transparent text-slate-500';
            document.getElementById('opt-sales').classList.toggle('hidden', !isSale);
            document.getElementById('opt-expenses').classList.toggle('hidden', isSale);
        }

        async function addRecord() {
            const amountInput = document.getElementById('amount');
            const amount = parseFloat(amountInput.value);
            const desc = document.getElementById('item-desc').value;
            const saveBtn = document.getElementById('save-btn');

            if (!amount || amount <= 0) return;

            saveBtn.disabled = true;
            saveBtn.innerText = "Syncing Cloud...";

            const recordData = { type: currentType, amount, desc, timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) };
            
            records.unshift(recordData); // Add to top of history
            localStorage.setItem('daily_records', JSON.stringify(records));
            updateDashboard();

            try {
                await fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(recordData) });
            } catch (e) { console.log("Offline"); }

            amountInput.value = '';
            saveBtn.disabled = false;
            saveBtn.innerText = 'Save Transaction';
        }

        function updateDashboard() {
            let sTotal = 0, eTotal = 0, sCount = 0, eCount = 0;
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';

            records.forEach((r, idx) => {
                if (r.type === 'sale') { sTotal += r.amount; sCount++; }
                else { eTotal += r.amount; eCount++; }
                
                // Only show last 5 in UI list
                if(idx < 5) {
                    listEl.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border-l-4 ${r.type === 'sale' ? 'border-green-500' : 'border-red-500'}">
                            <div><p class="font-bold text-slate-800 text-sm">${r.desc}</p><p class="text-[10px] text-slate-400">${r.timestamp}</p></div>
                            <p class="font-black ${r.type === 'sale' ? 'text-green-600' : 'text-red-600'}">${r.type === 'sale' ? '+' : '-'} ${r.amount}</p>
                        </div>`;
                }
            });

            document.getElementById('stat-sales').innerText = `Ksh ${sTotal}`;
            document.getElementById('stat-expenses').innerText = `Ksh ${eTotal}`;
            document.getElementById('stat-profit').innerText = `Ksh ${sTotal - eTotal}`;
            document.getElementById('count-sale').innerText = sCount;
            document.getElementById('count-expense').innerText = eCount;
            liveChart.data.datasets[0].data = [sTotal, eTotal];
            liveChart.update();
        }

        updateDashboard();
    </script>
</body>
</html>
