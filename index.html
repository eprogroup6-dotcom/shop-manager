<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Manager - Kenya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-4 pb-10">

    <div class="max-w-md mx-auto space-y-4">
        <div class="bg-indigo-700 rounded-3xl p-6 text-white shadow-xl">
            <div class="flex justify-between items-start mb-2">
                <h1 class="text-sm opacity-90 uppercase tracking-wider font-bold">Daily Profit</h1>
                <span id="current-time" class="text-xs bg-indigo-800 px-2 py-1 rounded">00:00:00</span>
            </div>
            <p id="stat-profit" class="text-4xl font-black">Ksh 0</p>
            
            <div class="grid grid-cols-2 gap-4 mt-6 pt-4 border-t border-indigo-500">
                <div>
                    <p class="text-xs opacity-70">Sales (<span id="count-sale">0</span>)</p>
                    <p id="stat-sales" class="font-bold text-green-400">Ksh 0</p>
                </div>
                <div>
                    <p class="text-xs opacity-70">Expenses (<span id="count-expense">0</span>)</p>
                    <p id="stat-expenses" class="font-bold text-red-400">Ksh 0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-sm">
            <div class="flex bg-gray-100 p-1 rounded-2xl mb-4">
                <button onclick="setType('sale')" id="btn-sale" class="flex-1 py-3 rounded-xl font-bold transition-all bg-white shadow-sm text-indigo-700">Sale</button>
                <button onclick="setType('expense')" id="btn-expense" class="flex-1 py-3 rounded-xl font-bold transition-all text-gray-500">Expense</button>
            </div>

            <div class="space-y-4">
                <select id="item-desc" class="w-full p-4 bg-gray-50 border-none rounded-2xl text-gray-700 focus:ring-2 focus:ring-indigo-500">
                    <optgroup label="Products for Sale" id="opt-sales">
                        <option value="Soda">Soda</option>
                        <option value="Bread">Bread</option>
                        <option value="Milk">Milk</option>
                        <option value="Snacks">Snacks</option>
                    </optgroup>
                    <optgroup label="Expenses" id="opt-expenses" class="hidden">
                        <option value="Transport">Transport</option>
                        <option value="Electricity">Electricity</option>
                        <option value="Airtime">Airtime</option>
                        <option value="Packaging">Packaging</option>
                    </optgroup>
                </select>

                <input type="number" id="amount" placeholder="Ksh Amount" class="w-full p-4 bg-gray-50 border-none rounded-2xl text-xl font-bold">
                
                <button onclick="addRecord()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform">
                    Save to Ledger
                </button>
            </div>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-sm">
            <canvas id="liveChart"></canvas>
        </div>
    </div>

    <script>
        let currentType = 'sale';
        let records = JSON.parse(localStorage.getItem('daily_records')) || [];
        let lastResetDate = localStorage.getItem('last_reset_date');

        // Check for Midnight Reset
        function checkMidnightReset() {
            const now = new Date();
            const today = now.toDateString();
            
            if (lastResetDate !== today) {
                records = [];
                localStorage.setItem('daily_records', JSON.stringify([]));
                localStorage.setItem('last_reset_date', today);
                updateDashboard();
            }
            document.getElementById('current-time').innerText = now.toLocaleTimeString();
        }
        setInterval(checkMidnightReset, 1000);

        // Chart Init
        const ctx = document.getElementById('liveChart').getContext('2d');
        const liveChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Sales', 'Expenses'],
                datasets: [{
                    label: 'Ksh',
                    data: [0, 0],
                    backgroundColor: ['#4ade80', '#f87171'],
                    borderRadius: 10
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        function setType(type) {
            currentType = type;
            const isSale = type === 'sale';
            document.getElementById('btn-sale').className = isSale ? 'flex-1 py-3 rounded-xl font-bold bg-white shadow-sm text-indigo-700' : 'flex-1 py-3 rounded-xl font-bold text-gray-500';
            document.getElementById('btn-expense').className = !isSale ? 'flex-1 py-3 rounded-xl font-bold bg-white shadow-sm text-red-600' : 'flex-1 py-3 rounded-xl font-bold text-gray-500';
            document.getElementById('opt-sales').classList.toggle('hidden', !isSale);
            document.getElementById('opt-expenses').classList.toggle('hidden', isSale);
        }

        function addRecord() {
            const amount = parseFloat(document.getElementById('amount').value);
            const desc = document.getElementById('item-desc').value;
            const timestamp = new Date().toISOString();

            if (!amount || amount <= 0) return;

            records.push({ type: currentType, amount, desc, timestamp });
            localStorage.setItem('daily_records', JSON.stringify(records));
            
            updateDashboard();
            document.getElementById('amount').value = '';
            
            // In next step, we will trigger the Google Sheets sync here
            console.log("Ready to sync:", {timestamp, currentType, desc, amount});
        }

        function updateDashboard() {
            let sTotal = 0, eTotal = 0, sCount = 0, eCount = 0;

            records.forEach(r => {
                if (r.type === 'sale') { sTotal += r.amount; sCount++; }
                else { eTotal += r.amount; eCount++; }
            });

            document.getElementById('stat-sales').innerText = `Ksh ${sTotal}`;
            document.getElementById('stat-expenses').innerText = `Ksh ${eTotal}`;
            document.getElementById('stat-profit').innerText = `Ksh ${sTotal - eTotal}`;
            document.getElementById('count-sale').innerText = sCount;
            document.getElementById('count-expense').innerText = eCount;

            liveChart.data.datasets[0].data = [sTotal, eTotal];
            liveChart.update();
        }

        // Initial Load
        updateDashboard();
        checkMidnightReset();
    </script>
</body>
</html>
